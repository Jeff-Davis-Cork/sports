<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeff's Sports & TV</title>
    <style>
        :root { --bg: #0a0f1e; --card: #161e35; --accent: #38bdf8; --text: #f8fafc; --danger: #ff4757; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; text-align: center; overflow-x: hidden; }
        .hidden { display: none !important; }
        
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        h1 { color: var(--accent); font-size: 2.5rem; }
        input { width: 100%; max-width: 400px; padding: 15px; border-radius: 12px; border: 2px solid #334155; background: #0f172a; color: white; font-size: 1.2rem; outline: none; }
        button { padding: 15px 30px; background: var(--accent); color: #0a0f1e; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 1.1rem; }

        /* Grid UI */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 20px; }
        .card { background: var(--card); padding: 30px 15px; border-radius: 15px; cursor: pointer; border: 1px solid #334155; font-weight: bold; transition: 0.2s; min-height: 60px; display: flex; align-items: center; justify-content: center; text-transform: uppercase; font-size: 0.9rem; }
        .card:hover { border-color: var(--accent); transform: scale(1.05); }

        /* Full Screen Player */
        #player-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 9999; }
        iframe { width: 100%; height: 100%; border: none; }

        /* Back Navigation Message */
        #nav-tip {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 100010; background: rgba(0,0,0,0.8); color: #fff;
            padding: 10px 20px; border-radius: 30px; border: 1px solid var(--accent);
            font-size: 0.9rem; pointer-events: none; opacity: 0; transition: opacity 0.5s;
        }

        /* 20-Second Strobe Shield */
        #click-shield {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100000; background: rgba(0,0,0,0.96);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #click-shield.strobe-open { background: transparent !important; border: 8px solid var(--accent); box-sizing: border-box; }

        /* Large Instructions */
        .instruction-box { background: rgba(10, 15, 30, 0.95); padding: 40px; border-radius: 20px; border: 4px solid var(--accent); max-width: 85%; }
        .urgent-text { font-size: 3rem; color: #fff; font-weight: 900; animation: flash-accent 0.8s infinite; line-height: 1.1; margin: 20px 0; }
        
        #progress-wrap { width: 100%; height: 15px; background: #222; border-radius: 10px; margin-top: 20px; overflow: hidden; }
        #progress-fill { height: 100%; width: 0%; background: var(--accent); transition: width 0.1s linear; }

        @keyframes flash-accent {
            0%, 100% { color: #fff; transform: scale(1); }
            50% { color: var(--accent); transform: scale(1.03); }
        }
    </style>
</head>
<body>

<!-- 1. Password Screen -->
<div id="login-screen" class="container">
    <br><br><h1>Jeff's Sports & TV</h1>
    <input type="password" id="pass-input" placeholder="Password..." onkeydown="if(event.key==='Enter') checkPassword()">
    <br><br><button onclick="checkPassword()">Let's Do This!</button>
</div>

<!-- 2. Channel Selection Screen -->
<div id="list-screen" class="container hidden">
    <h1>Jeff's Channels</h1>
    <input type="text" id="search-bar" placeholder="üîç Search channels..." onkeyup="filterChannels()" style="width:100%; max-width:100%; border:2px solid #38bdf8; box-sizing:border-box; padding:15px; border-radius:10px; background:#0f172a; color:white;">
    <div id="channel-grid" class="grid">Loading Channels...</div>
</div>

<!-- 3. Source Selection Screen -->
<div id="source-screen" class="container hidden">
    <button onclick="showScreen('list-screen')" style="background:#475569; color:white;">‚Üê Back</button>
    <h2 id="target-name" style="color: var(--accent); font-size: 2rem;"></h2>
    <div id="source-options"></div>
</div>

<!-- 4. Full Player Screen -->
<div id="player-screen" class="hidden">
    <div id="nav-tip">Tip: Use your browser's BACK button to exit video</div>
    
    <div id="click-shield" onclick="manualFlicker()">
        <div id="shield-ui" class="instruction-box">
            <h2 style="color: var(--accent); margin: 0;">PROTECTION BYPASS ACTIVE</h2>
            <div id="progress-wrap"><div id="progress-fill"></div></div>
            <div class="urgent-text">CLICK ANY UNMUTE OR PLAY BUTTONS NOW!</div>
            <h3 id="timer-text" style="color: #fff; font-size: 1.5rem;">20s remaining</h3>
        </div>
    </div>
    <div id="iframe-container" style="width:100%; height:100%;"></div>
</div>

<script>
    const CONFIG = { DOMAIN: "dlhd.link", PASS: "jeff" };
    let selectedID = "", allChannels = [];

    // 1. Login Logic
    function checkPassword() {
        if (document.getElementById('pass-input').value.toLowerCase() === CONFIG.PASS) {
            showScreen('list-screen');
            loadChannels();
        } else { alert("Incorrect password, Jeff!"); }
    }

    // 2. Fetch Channels via AllOrigins Proxy (to bypass 403 Forbidden)
    async function loadChannels() {
        const target = `https://${CONFIG.DOMAIN}/24-7-channels.php`;
        const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(target)}`;
        
        try {
            const resp = await fetch(proxy);
            const data = await resp.json();
            // AllOrigins returns the HTML content as a string inside 'contents'
            if (data.contents) {
                processHTML(data.contents);
            } else {
                throw new Error("No data returned");
            }
        } catch (e) { 
            console.error("Fetch error:", e);
            document.getElementById('channel-grid').innerHTML = "<p style='color:red;'>Failed to load channels. The proxy may be down.</p>";
        }
    }

    // 3. Parse HTML and find Channel IDs
    function processHTML(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        allChannels = [];
        
        // Find all links containing "id="
        const links = doc.querySelectorAll('a[href*="id="]');
        
        links.forEach(link => {
            const href = link.getAttribute('href');
            const idMatch = href.match(/id=(\d+)/);
            // Get channel name from data-title, or the text inside the link
            let title = link.getAttribute('data-title') || link.innerText.trim();
            
            if (idMatch && title && title.length > 1) {
                // Remove duplicates based on ID
                if (!allChannels.find(c => c.id === idMatch[1])) {
                    allChannels.push({ id: idMatch[1], name: title });
                }
            }
        });

        if (allChannels.length === 0) {
            document.getElementById('channel-grid').innerHTML = "<p style='color:orange;'>No channels found. Site structure might have changed.</p>";
        } else {
            renderGrid(allChannels);
        }
    }

    // 4. Render Grid of Buttons
    function renderGrid(channels) {
        const grid = document.getElementById('channel-grid');
        grid.innerHTML = channels.map(ch => `
            <div class="card" onclick="selectChannel('${ch.id}', '${ch.name.replace(/'/g, "\\'")}')">
                ${ch.name}
            </div>
        `).join('');
    }

    // 5. Search Filtering
    function filterChannels() {
        const q = document.getElementById('search-bar').value.toLowerCase();
        renderGrid(allChannels.filter(ch => ch.name.toLowerCase().includes(q)));
    }

    // 6. Select Channel & Show Source Options
    function selectChannel(id, name) {
        selectedID = id;
        document.getElementById('target-name').innerText = name;
        showScreen('source-screen');
        
        const sources = ['stream', 'cast', 'watch', 'player'];
        document.getElementById('source-options').innerHTML = sources.map(s => `
            <button style="display:block; width:100%; max-width:400px; margin:10px auto; padding:20px; border-radius:15px; background:#161e35; color:white; border:2px solid #38bdf8; cursor:pointer; font-weight:bold;" onclick="startStream('${s}')">SOURCE ${s.toUpperCase()}</button>
        `).join('');
    }

    // 7. Start the Player with the 20-second Strobe Bypass
    function startStream(path) {
        showScreen('player-screen');
        const shield = document.getElementById('click-shield');
        const fill = document.getElementById('progress-fill');
        const timerTxt = document.getElementById('timer-text');
        const tip = document.getElementById('nav-tip');
        
        tip.style.opacity = "1";
        setTimeout(() => { tip.style.opacity = "0"; }, 4000);

        shield.style.pointerEvents = "auto";
        shield.classList.remove('strobe-open');
        document.getElementById('shield-ui').classList.remove('hidden');
        fill.style.width = "0%";
        
        // Construct the URL: e.g. https://dlhd.link/stream/stream-38.php
        const url = `https://${CONFIG.DOMAIN}/${path}/stream-${selectedID}.php`;
        
        // No sandbox used here to allow full player functionality
        document.getElementById('iframe-container').innerHTML = `
            <iframe src="${url}" allowfullscreen scrolling="no" style="border:0; width:100%; height:100%;"></iframe>
        `;

        let timeElapsed = 0;
        const totalDuration = 200; // 20 seconds
        
        const strobeInterval = setInterval(() => {
            timeElapsed++;
            fill.style.width = (timeElapsed / 2) + "%";
            timerTxt.innerText = `${Math.ceil((totalDuration - timeElapsed) / 10)}s remaining`;

            // This creates the "flicker" that allows clicks to pass through to the player
            if (shield.style.pointerEvents === "none") {
                shield.style.pointerEvents = "auto";
                shield.classList.remove('strobe-open');
            } else {
                shield.style.pointerEvents = "none";
                shield.classList.add('strobe-open');
            }

            if (timeElapsed >= totalDuration) {
                clearInterval(strobeInterval);
                shield.style.pointerEvents = "auto";
                shield.classList.add('strobe-open');
                document.getElementById('shield-ui').classList.add('hidden');
            }
        }, 100);
    }

    // Manual Flicker for mobile or slow devices
    function manualFlicker() {
        const shield = document.getElementById('click-shield');
        shield.style.pointerEvents = "none";
        setTimeout(() => { shield.style.pointerEvents = "auto"; }, 200);
    }

    // Handle back button behavior
    window.onpopstate = function() {
        if (!document.getElementById('player-screen').classList.contains('hidden')) {
            closePlayer();
        }
    };

    function closePlayer() {
        document.getElementById('iframe-container').innerHTML = "";
        showScreen('source-screen');
    }

    function showScreen(id) {
        if (id !== 'login-screen') window.history.pushState({screen: id}, "");
        ['login-screen', 'list-screen', 'source-screen', 'player-screen'].forEach(s => {
            document.getElementById(s).classList.add('hidden');
        });
        document.getElementById(id).classList.remove('hidden');
    }
</script>

</body>
</html>
